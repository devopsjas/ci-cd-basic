name: Docker CI Pipeline

on:
  push:
    branches:
      - main

jobs:
  docker-build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Build Docker Image
      run: |
        docker build -t docker-cicd-app .

    - name: Run Docker Container
      run: |
        docker run -d -p 8080:80 docker-cicd-app

    - name: Verify Running Containers
      run: |
        docker ps

    - name: Download & Install ngrok (NO APT)
      run: |
        curl -L https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz -o ngrok.tgz
        tar -xzf ngrok.tgz
        sudo mv ngrok /usr/local/bin/ngrok
        ngrok version

    # - name: Start ngrok and print public URL
    #   run: |
    #     ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
    #     ngrok http 8080 > ngrok.log &
    #     sleep 10
    #     curl http://127.0.0.1:4040/api/tunnels
    #     echo "Keeping job alive for 10 minutes..."
    #     sleep 600

    - name: Start ngrok and PRINT PUBLIC URL
      run: |
        ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ngrok http 8080 > ngrok.log &
        sleep 10

        URL=$(curl -s http://127.0.0.1:4040/api/tunnels \
          | jq -r '.tunnels[0].public_url')

        echo ""
        echo "======================================="
        echo "ðŸš€ðŸš€ðŸš€ YOUR PUBLIC URL ðŸš€ðŸš€ðŸš€"
        echo ""
        echo "$URL"
        echo ""
        echo "======================================="
        echo ""
        sleep 60
